<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro Innovation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .table-input {
            width: 100%;
            background-color: #f0f4f8;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
        }
        .table-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
         .loading-text {
            font-size: 1.5rem; /* Larger than metric titles */
            font-weight: 500;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Micro Innovation Dashboard</h1>
            <p class="text-md text-gray-600 mt-2">Track and manage your team's innovative projects and their impact.</p>
            <div id="user-info" class="mt-4 p-3 bg-blue-100 text-blue-800 rounded-md text-sm hidden">
                Your User ID (UID) is: <strong id="user-uid-display" class="font-bold"></strong> (Use this to grant yourself admin access)
            </div>
        </header>

        <!-- Key Metrics -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center justify-center">
                <h2 class="text-lg font-semibold text-gray-500">Total Projects</h2>
                <p id="total-projects" class="text-3xl font-bold text-blue-600 loading-text">...</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center justify-center">
                <h2 class="text-lg font-semibold text-gray-500">Total Hours Saved</h2>
                <p id="total-hours-saved" class="text-3xl font-bold text-green-600 loading-text">...</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center justify-center">
                <h2 class="text-lg font-semibold text-gray-500">Avg. Efficiency Gain</h2>
                <p id="avg-efficiency" class="text-3xl font-bold text-indigo-600 loading-text">...</p>
            </div>
             <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center justify-center">
                <h2 class="text-lg font-semibold text-gray-500">Most Used Method</h2>
                <p id="most-used-method" class="text-xl font-bold text-purple-600 loading-text">...</p>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Data Table -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Innovation Pipeline</h2>
                    <div class="flex items-center space-x-2 sm:space-x-4 mt-4 sm:mt-0">
                        <div>
                            <label for="team-filter" class="text-sm font-medium">Team:</label>
                            <select id="team-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option>All</option>
                            </select>
                        </div>
                        <div>
                            <label for="method-filter" class="text-sm font-medium">Method:</label>
                            <select id="method-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option>All</option>
                            </select>
                        </div>
                        <div>
                            <label for="status-filter" class="text-sm font-medium">Status:</label>
                            <select id="status-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option>All</option>
                            </select>
                        </div>
                    </div>
                 </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left" id="innovation-table">
                        <thead>
                            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6">Task Name</th>
                                <th class="py-3 px-6">Team</th>
                                <th class="py-3 px-6">Method</th>
                                <th class="py-3 px-6">Status</th>
                                <th class="py-3 px-6 text-center">Hours Before</th>
                                <th class="py-3 px-6 text-center">Hours After</th>
                                <th class="py-3 px-6 text-center">Efficiency Gain</th>
                                <th id="actions-header" class="py-3 px-6 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light">
                           <tr><td colspan="8" class="text-center p-4">Connecting to database...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Panel (Add/Import) -->
            <div id="admin-panel" class="bg-white p-6 rounded-lg shadow-md hidden">
                <!-- Add Item Form -->
                <div>
                    <h2 class="text-2xl font-bold mb-4">Add New Innovation</h2>
                    <form id="add-item-form">
                        <div class="mb-4">
                            <label for="taskName" class="block text-sm font-medium text-gray-700">Task Name</label>
                            <input type="text" id="taskName" name="taskName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                        </div>
                         <div class="mb-4">
                            <label for="team" class="block text-sm font-medium text-gray-700">Team</label>
                            <input type="text" id="team" name="team" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                        </div>
                        <div class="mb-4">
                            <label for="innovationMethod" class="block text-sm font-medium text-gray-700">Innovation Method</label>
                            <input type="text" id="innovationMethod" name="innovationMethod" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                        </div>
                        <div class="mb-4">
                            <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                            <select id="status" name="status" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                                <option>Idea</option>
                                <option>In Progress</option>
                                <option>Completed</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="hoursBefore" class="block text-sm font-medium text-gray-700">Operation Hours Before</label>
                            <input type="number" id="hoursBefore" name="hoursBefore" step="0.1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                        </div>
                        <div class="mb-4">
                            <label for="hoursAfter" class="block text-sm font-medium text-gray-700">Operation Hours After</label>
                            <input type="number" id="hoursAfter" name="hoursAfter" step="0.1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Add Item
                        </button>
                    </form>
                </div>
                <!-- File Import Section -->
                <div class="mt-8 border-t pt-6">
                    <h2 class="text-2xl font-bold mb-4">Import from File</h2>
                    <p class="text-sm text-gray-600 mb-2">File (CSV or XLSX) must have headers: <br><code class="text-xs bg-gray-200 p-1 rounded">Task Name,Team,Method,Status,Hours Before,Hours After</code></p>
                    <input type="file" id="file-input" accept=".csv, .xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <button id="import-btn" class="mt-4 w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Import File
                    </button>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
                 <h2 class="text-2xl font-bold mb-4">Efficiency Gain by Task</h2>
                 <div class="relative h-96">
                    <canvas id="taskEfficiencyChart"></canvas>
                 </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                 <h2 class="text-2xl font-bold mb-4">Average Efficiency by Team</h2>
                 <div class="relative h-96">
                    <canvas id="teamEfficiencyChart"></canvas>
                 </div>
            </div>
        </div>

    </div>

    <!-- Modal for notifications -->
    <div id="notification-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900">Notification</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="modal-message" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal-btn" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp as initializeFirebaseApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Admin Configuration ---
        // IMPORTANT: Add the Firebase Authentication UID of each admin user here.
        const ADMIN_UIDS = ["35MaZO8wB2RorbLxc9ptR6j1NCB3"]; 

        // --- Firebase Configuration ---
        const YOUR_FIREBASE_CONFIG = {
          apiKey: "AIzaSyBXXSd3BpMDdllqG07R2OVnRTiqvrm79Tc",
          authDomain: "micro-innovation-dashboard.firebaseapp.com",
          projectId: "micro-innovation-dashboard",
          storageBucket: "micro-innovation-dashboard.appspot.com",
          messagingSenderId: "344370578673",
          appId: "1:344370578673:web:9722b7fc16ac5a3acb1550"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : YOUR_FIREBASE_CONFIG;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- DOM Elements ---
        const form = document.getElementById('add-item-form');
        const adminPanel = document.getElementById('admin-panel');
        const tableBody = document.querySelector('#innovation-table tbody');
        const modal = document.getElementById('notification-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const teamFilter = document.getElementById('team-filter');
        const methodFilter = document.getElementById('method-filter');
        const statusFilter = document.getElementById('status-filter');
        const actionsHeader = document.getElementById('actions-header');
        const fileInput = document.getElementById('file-input');
        const importBtn = document.getElementById('import-btn');

        // --- App State ---
        let db; // Firestore instance
        let taskEfficiencyChart;
        let teamEfficiencyChart;
        let allInnovationData = []; 
        let unsubscribe; // To store the Firestore listener
        let currentUserIsAdmin = false;
        const STATUS_OPTIONS = ["Idea", "In Progress", "Completed"];

        // --- Main App Logic ---
        function startApp() {
            renderTaskChart(); 
            renderTeamChart();

            if (!firebaseConfig) {
                const errorMessage = "This dashboard is not connected to a database. Please add your Firebase project configuration to the 'YOUR_FIREBASE_CONFIG' variable in the script section of this file to enable live data.";
                showError("Configuration Needed", errorMessage);
                return; 
            }

            const app = initializeFirebaseApp(firebaseConfig);
            const auth = getAuth(app);
            db = getFirestore(app); 

            onAuthStateChanged(auth, user => {
                if (user) {
                    // Display UID prominently on the page
                    const userInfoDiv = document.getElementById('user-info');
                    const userUidDisplay = document.getElementById('user-uid-display');
                    if (userInfoDiv && userUidDisplay) {
                        userUidDisplay.textContent = user.uid;
                        userInfoDiv.classList.remove('hidden');
                    }
                    
                    currentUserIsAdmin = ADMIN_UIDS.includes(user.uid);
                    toggleAdminUI(currentUserIsAdmin);

                    if (unsubscribe) unsubscribe(); 
                    
                    const dataCollection = collection(db, `/artifacts/${appId}/public/data/innovations`);
                    unsubscribe = onSnapshot(dataCollection, (snapshot) => {
                        allInnovationData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        populateFilters(allInnovationData);
                        applyFilters();
                    }, (error) => {
                        console.error("Firestore listener error: ", error);
                        showError("Data Error", "Failed to retrieve live data. Please check your connection or permissions.");
                    });
                } else {
                     currentUserIsAdmin = false;
                     toggleAdminUI(false);
                     if (unsubscribe) unsubscribe();
                     updateDashboard([], true); 
                }
            });

            // Attempt to sign in
            (async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                     console.error("Authentication failed:", e);
                     showError("Authentication Failed", "Could not sign in to the database service. Please try reloading the page.");
                }
            })();
        }

        document.addEventListener('DOMContentLoaded', startApp);
        
        // --- UI Control ---
        function toggleAdminUI(isAdmin) {
            if (isAdmin) {
                adminPanel.classList.remove('hidden');
                actionsHeader.classList.remove('hidden');
            } else {
                adminPanel.classList.add('hidden');
                actionsHeader.classList.add('hidden');
            }
            // Re-render table to show/hide action buttons in rows
            applyFilters();
        }

        // --- Filtering Logic ---
        teamFilter.addEventListener('change', applyFilters);
        methodFilter.addEventListener('change', applyFilters);
        statusFilter.addEventListener('change', applyFilters);

        function populateFilters(data) {
            const teams = [...new Set(data.map(item => item.team))].sort();
            const methods = [...new Set(data.map(item => item.method))].sort();
            const statuses = [...new Set(data.map(item => item.status))].sort();
            
            const currentTeam = teamFilter.value;
            teamFilter.innerHTML = '<option>All</option>';
            teams.forEach(team => {
                teamFilter.innerHTML += `<option value="${team}">${team}</option>`;
            });
            teamFilter.value = teams.includes(currentTeam) ? currentTeam : 'All';


            const currentMethod = methodFilter.value;
            methodFilter.innerHTML = '<option>All</option>';
            methods.forEach(method => {
                methodFilter.innerHTML += `<option value="${method}">${method}</option>`;
            });
            methodFilter.value = methods.includes(currentMethod) ? currentMethod : 'All';

            const currentStatus = statusFilter.value;
            statusFilter.innerHTML = '<option>All</option>';
            statuses.forEach(status => {
                statusFilter.innerHTML += `<option value="${status}">${status}</option>`;
            });
            statusFilter.value = statuses.includes(currentStatus) ? currentStatus : 'All';
        }

        function applyFilters() {
            const selectedTeam = teamFilter.value;
            const selectedMethod = methodFilter.value;
            const selectedStatus = statusFilter.value;

            let filteredData = allInnovationData;

            if (selectedTeam !== 'All') {
                filteredData = filteredData.filter(item => item.team === selectedTeam);
            }
            if (selectedMethod !== 'All') {
                filteredData = filteredData.filter(item => item.method === selectedMethod);
            }
            if (selectedStatus !== 'All') {
                filteredData = filteredData.filter(item => item.status === selectedStatus);
            }
            
            renderTable(filteredData);
            updateDashboard(filteredData);
            updateTaskChart(filteredData);
            updateTeamChart(filteredData);
        }

        // --- UI Rendering ---
        function getStatusBadge(status) {
            switch (status) {
                case 'Completed':
                    return `<span class="status-badge bg-green-200 text-green-800">${status}</span>`;
                case 'In Progress':
                    return `<span class="status-badge bg-yellow-200 text-yellow-800">${status}</span>`;
                case 'Idea':
                default:
                    return `<span class="status-badge bg-blue-200 text-blue-800">${status || 'Idea'}</span>`;
            }
        }

        function renderTable(data) {
            if (data.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4">No innovations match the current filters.</td></tr>`;
                 return;
            }
            tableBody.innerHTML = ''; 
            data.forEach(item => {
                const efficiency = item.hoursBefore > 0 ? Math.round(((item.hoursBefore - item.hoursAfter) / item.hoursBefore) * 100) : 0;
                
                const actionsHtml = currentUserIsAdmin ? `
                    <td class="py-3 px-6 text-center">
                        <button class="text-indigo-600 hover:text-indigo-900 mr-2" onclick="window.app.editRow(this)">Edit</button>
                        <button class="text-red-600 hover:text-red-900" onclick="window.app.deleteRow(this)">Delete</button>
                    </td>
                ` : `<td class="py-3 px-6 text-center"></td>`;

                const rowHtml = `
                    <tr class="border-b border-gray-200 hover:bg-gray-100" data-id="${item.id}">
                        <td class="py-3 px-6">${item.taskName}</td>
                        <td class="py-3 px-6">${item.team}</td>
                        <td class="py-3 px-6">${item.method}</td>
                        <td class="py-3 px-6">${getStatusBadge(item.status)}</td>
                        <td class="py-3 px-6 text-center">${item.hoursBefore}</td>
                        <td class="py-3 px-6 text-center">${item.hoursAfter}</td>
                        <td class="py-3 px-6 text-center text-green-600 font-semibold">${efficiency}%</td>
                        ${actionsHtml}
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', rowHtml);
            });
        }

        // --- Form Submission ---
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!db) {
                showError("Database Error", "Not connected to the database.");
                return;
            }
            const taskName = e.target.taskName.value.trim();
            const team = e.target.team.value.trim();
            const innovationMethod = e.target.innovationMethod.value.trim();
            const status = e.target.status.value;
            const hoursBefore = parseFloat(e.target.hoursBefore.value);
            const hoursAfter = parseFloat(e.target.hoursAfter.value);

            if (taskName === '' || team === '' || innovationMethod === '' || isNaN(hoursBefore) || isNaN(hoursAfter) || hoursBefore <= 0 || hoursAfter < 0) {
                 showMessage('Invalid Input','Please fill in all fields with valid numbers.');
                 return;
            }
             if (hoursAfter >= hoursBefore) {
                showMessage('Invalid Input','Hours after must be less than hours before.');
                return;
            }
            
            try {
                const dataCollection = collection(db, `/artifacts/${appId}/public/data/innovations`);
                await addDoc(dataCollection, { taskName, team, method: innovationMethod, status, hoursBefore, hoursAfter });
                showMessage("Success!","New innovation added successfully!");
                form.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
                showError("Save Error", "Failed to add item. Please try again.");
            }
        });
        
        // --- File Import ---
        importBtn.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (!file) {
                showMessage("No File", "Please select a file to import.");
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = e.target.result;
                if (file.name.endsWith('.csv')) {
                    Papa.parse(data, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => processImportedData(results.data),
                        error: (err) => showError("File Error", "Could not parse the CSV file.")
                    });
                } else if (file.name.endsWith('.xlsx')) {
                    try {
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        processImportedData(jsonData);
                    } catch (error) {
                        console.error("XLSX parsing error:", error);
                        showError("File Error", "Could not parse the XLSX file.");
                    }
                } else {
                    showError("Unsupported File", "Please select a CSV or XLSX file.");
                }
            };

            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        });

        async function processImportedData(data) {
            if (!data || data.length === 0) {
                showMessage("No Data", "No valid data found in the file to import.");
                return;
            }

            const expectedHeaders = ["Task Name", "Team", "Method", "Status", "Hours Before", "Hours After"];
            const actualHeaders = Object.keys(data[0]);
            const hasAllHeaders = expectedHeaders.every(h => actualHeaders.includes(h));

            if (!hasAllHeaders) {
                showError("Invalid File", `File headers are incorrect. Expected: ${expectedHeaders.join(', ')}`);
                return;
            }

            const dataToUpload = [];
            for (const row of data) {
                const taskName = row["Task Name"]?.trim();
                const team = row["Team"]?.trim();
                const method = row["Method"]?.trim();
                const status = row["Status"]?.trim();
                const hoursBefore = parseFloat(row["Hours Before"]);
                const hoursAfter = parseFloat(row["Hours After"]);

                if (taskName && team && method && status && STATUS_OPTIONS.includes(status) && !isNaN(hoursBefore) && !isNaN(hoursAfter) && hoursBefore > hoursAfter) {
                    dataToUpload.push({ taskName, team, method, status, hoursBefore, hoursAfter });
                } else {
                    console.warn("Skipping invalid row:", row);
                }
            }

            if (dataToUpload.length > 0) {
                try {
                    const dataCollection = collection(db, `/artifacts/${appId}/public/data/innovations`);
                    await Promise.all(dataToUpload.map(item => addDoc(dataCollection, item)));
                    showMessage("Import Successful", `Successfully imported ${dataToUpload.length} innovations.`);
                    fileInput.value = ''; // Clear the file input
                } catch(error) {
                    console.error("Error during bulk upload:", error);
                    showError("Import Error", "An error occurred while saving the data. Please try again.");
                }
            } else {
                showMessage("No Data", "No valid data rows found in the file to import.");
            }
        }

        // --- Data Manipulation Functions ---
        async function deleteRow(button) {
            const row = button.closest('tr');
            const docId = row.dataset.id;
            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/innovations`, docId);
                await deleteDoc(docRef);
            } catch (error) {
                console.error("Error deleting document: ", error);
                showError("Delete Error","Failed to delete item. Please try again.");
            }
        }

        function editRow(button) {
            const row = button.closest('tr');
            const cells = row.querySelectorAll('td');

            row.dataset.originalTaskName = cells[0].innerText;
            row.dataset.originalTeam = cells[1].innerText;
            row.dataset.originalMethod = cells[2].innerText;
            row.dataset.originalStatus = cells[3].querySelector('span').innerText;
            row.dataset.originalHoursBefore = cells[4].innerText;
            row.dataset.originalHoursAfter = cells[5].innerText;

            cells[0].innerHTML = `<input type="text" value="${row.dataset.originalTaskName}" class="table-input">`;
            cells[1].innerHTML = `<input type="text" value="${row.dataset.originalTeam}" class="table-input">`;
            cells[2].innerHTML = `<input type="text" value="${row.dataset.originalMethod}" class="table-input">`;
            
            const statusOptionsHtml = STATUS_OPTIONS.map(opt => `<option value="${opt}" ${opt === row.dataset.originalStatus ? 'selected' : ''}>${opt}</option>`).join('');
            cells[3].innerHTML = `<select class="table-input">${statusOptionsHtml}</select>`;
            
            cells[4].innerHTML = `<input type="number" step="0.1" value="${row.dataset.originalHoursBefore}" class="table-input text-center">`;
            cells[5].innerHTML = `<input type="number" step="0.1" value="${row.dataset.originalHoursAfter}" class="table-input text-center">`;

            cells[7].innerHTML = `
                <button class="text-green-600 hover:text-green-900 mr-2" onclick="window.app.saveRow(this)">Save</button>
                <button class="text-gray-600 hover:text-gray-900" onclick="window.app.cancelEdit(this)">Cancel</button>
            `;
        }

        async function saveRow(button) {
            const row = button.closest('tr');
            const docId = row.dataset.id;
            const inputs = row.querySelectorAll('input, select');

            const taskName = inputs[0].value.trim();
            const team = inputs[1].value.trim();
            const method = inputs[2].value.trim();
            const status = inputs[3].value;
            const hoursBefore = parseFloat(inputs[4].value);
            const hoursAfter = parseFloat(inputs[5].value);

            if (taskName === '' || team === '' || method === '' || isNaN(hoursBefore) || isNaN(hoursAfter) || hoursBefore <= 0 || hoursAfter < 0) {
                 showMessage('Invalid Input','Please fill in all fields with valid numbers.');
                 return;
            }
            if (hoursAfter >= hoursBefore) {
                showMessage('Invalid Input','Hours after must be less than hours before.');
                return;
            }

            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/innovations`, docId);
                await updateDoc(docRef, { taskName, team, method, status, hoursBefore, hoursAfter });
            } catch (error) {
                console.error("Error updating document: ", error);
                showError("Update Error","Failed to save changes. Please try again.");
                cancelEdit(button); // Revert UI on failure
            }
        }

        function cancelEdit(button) {
            const row = button.closest('tr');
            const cells = row.querySelectorAll('td');

            const originalHoursBefore = parseFloat(row.dataset.originalHoursBefore);
            const originalHoursAfter = parseFloat(row.dataset.originalHoursAfter);
            const efficiency = originalHoursBefore > 0 ? Math.round(((originalHoursBefore - originalHoursAfter) / originalHoursBefore) * 100) : 0;
            
            cells[0].innerText = row.dataset.originalTaskName;
            cells[1].innerText = row.dataset.originalTeam;
            cells[2].innerText = row.dataset.originalMethod;
            cells[3].innerHTML = getStatusBadge(row.dataset.originalStatus);
            cells[4].innerText = row.dataset.originalHoursBefore;
            cells[5].innerText = row.dataset.originalHoursAfter;
            cells[6].innerHTML = `<span class="text-green-600 font-semibold">${efficiency}%</span>`;

            cells[7].innerHTML = `
                <button class="text-indigo-600 hover:text-indigo-900 mr-2" onclick="window.app.editRow(this)">Edit</button>
                <button class="text-red-600 hover:text-red-900" onclick="window.app.deleteRow(this)">Delete</button>
            `;
        }

        // --- Dashboard & Chart Updates ---
        function updateDashboard(data, isLoading = false) {
            const pProjects = document.getElementById('total-projects');
            const pHours = document.getElementById('total-hours-saved');
            const pEfficiency = document.getElementById('avg-efficiency');
            const pMethod = document.getElementById('most-used-method');

            if (isLoading) {
                pProjects.innerHTML = `<span class="loading-text">...</span>`;
                pHours.innerHTML = `<span class="loading-text">...</span>`;
                pEfficiency.innerHTML = `<span class="loading-text">...</span>`;
                pMethod.innerHTML = `<span class="loading-text">...</span>`;
                return;
            }

            pProjects.classList.remove('loading-text');
            pHours.classList.remove('loading-text');
            pEfficiency.classList.remove('loading-text');
            pMethod.classList.remove('loading-text');
            
            const totalProjects = data.length;
            const totalHoursSaved = data.reduce((acc, item) => acc + (item.hoursBefore - item.hoursAfter), 0);
            const totalEfficiencySum = data.reduce((acc, item) => {
                if (item.hoursBefore > 0) {
                    const efficiency = ((item.hoursBefore - item.hoursAfter) / item.hoursBefore) * 100;
                    return acc + efficiency;
                }
                return acc;
            }, 0);
            const avgEfficiency = totalProjects > 0 ? Math.round(totalEfficiencySum / totalProjects) : 0;
            const mostUsedMethod = getMostUsedMethod(data);

            pProjects.innerText = totalProjects;
            pHours.innerText = totalHoursSaved.toFixed(1);
            pEfficiency.innerText = `${avgEfficiency}%`;
            pMethod.innerText = mostUsedMethod || 'N/A';
        }

        function getMostUsedMethod(data) {
            if (data.length === 0) return 'N/A';
            const methodCounts = data.reduce((acc, item) => {
                acc[item.method] = (acc[item.method] || 0) + 1;
                return acc;
            }, {});
            if (Object.keys(methodCounts).length === 0) return 'NA';
            return Object.keys(methodCounts).reduce((a, b) => methodCounts[a] > methodCounts[b] ? a : b);
        }
        
        function generateColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                const hue = (i * 137.508) % 360; // Use golden angle for visually distinct colors
                colors.push(`hsla(${hue}, 70%, 60%, 0.8)`);
            }
            return colors;
        }

        function renderTaskChart() {
            const ctx = document.getElementById('taskEfficiencyChart').getContext('2d');
            taskEfficiencyChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [{
                    label: 'Efficiency Gain (%)',
                    data: [],
                    backgroundColor: [],
                    borderColor: [],
                    borderWidth: 1 }]
                },
                options: {
                    scales: { y: { beginAtZero: true, max: 100 }},
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function renderTeamChart() {
            const ctx = document.getElementById('teamEfficiencyChart').getContext('2d');
            teamEfficiencyChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [{
                    label: 'Average Efficiency Gain (%)',
                    data: [],
                    backgroundColor: [],
                    borderColor: [],
                    borderWidth: 1 }]
                },
                options: {
                    scales: { y: { beginAtZero: true, max: 100 }},
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        function updateTaskChart(data) {
             if (!taskEfficiencyChart) return;
             const colors = generateColors(data.length);
             taskEfficiencyChart.data.labels = data.map(item => item.taskName);
             taskEfficiencyChart.data.datasets[0].data = data.map(item => {
                if (item.hoursBefore > 0) {
                    return Math.round(((item.hoursBefore - item.hoursAfter) / item.hoursBefore) * 100)
                }
                return 0;
             });
             taskEfficiencyChart.data.datasets[0].backgroundColor = colors;
             taskEfficiencyChart.data.datasets[0].borderColor = colors.map(c => c.replace('0.8', '1'));
             taskEfficiencyChart.update();
        }

        function updateTeamChart(data) {
            if (!teamEfficiencyChart) return;

            const teamData = {};
            data.forEach(item => {
                if (item.hoursBefore > 0) {
                    if (!teamData[item.team]) {
                        teamData[item.team] = { totalGain: 0, count: 0 };
                    }
                    const efficiency = ((item.hoursBefore - item.hoursAfter) / item.hoursBefore) * 100;
                    teamData[item.team].totalGain += efficiency;
                    teamData[item.team].count++;
                }
            });

            const labels = Object.keys(teamData).sort();
            const chartData = labels.map(team => {
                const avg = teamData[team].totalGain / teamData[team].count;
                return Math.round(avg);
            });
            
            const colors = generateColors(labels.length);
            teamEfficiencyChart.data.labels = labels;
            teamEfficiencyChart.data.datasets[0].data = chartData;
            teamEfficiencyChart.data.datasets[0].backgroundColor = colors;
            teamEfficiencyChart.data.datasets[0].borderColor = colors.map(c => c.replace('0.8', '1'));
            teamEfficiencyChart.update();
        }

        // --- Utilities ---
        function showMessage(title, message) {
            modalTitle.innerText = title;
            modalMessage.innerText = message;
            modal.classList.remove('hidden');
        }

        function showError(title, message) {
            showMessage(title, message);
            updateDashboard([], true); // Reset metrics on error
            tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-red-500 font-semibold">${message}</td></tr>`;
        }

        closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
        
        // --- Expose functions to global scope for onclick handlers ---
        window.app = { deleteRow, editRow, saveRow, cancelEdit };

    </script>
</body>
</html>
